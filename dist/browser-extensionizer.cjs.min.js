"use strict";var t=require("crypto"),e=require("events"),n=new(function(){function t(){this.eventsFlagMap={},this.eventsMap={},this.runtime=chrome.runtime||null,this.commands=chrome.commands||null}return t.prototype.eventFunction=function(t,e){var n=this.eventsMap[t]||{};if(Object.keys(n).length>0)for(var i=0,o=Object.entries(n);i<o.length;i++){var r=o[i],s=r[0];(0,r[1])({key:s,data:e})}},t.prototype.removeEventFunction=function(t,e){if(this.eventsFlagMap[t]&&this.eventsMap[t][e])return"*"==e?(delete this.eventsMap[t],this.eventsMap[t]={}):delete this.eventsMap[t][e],Object.keys(this.eventsMap[t]).length<1},t.prototype.onInstalled=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.runtime)return console.warn("BrowserExt: Not support chrome.runtime");var i="installed";this.eventsFlagMap[i]||(this.eventsMap[i]={},this.runtime.onInstalled.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t},t.prototype.removeInstalled=function(t){var e=this;if(this.runtime){var n="installed";this.removeEventFunction(n,t)||(this.runtime.onInstalled.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap[n]=!1)}},t.prototype.onConnect=function(t,e){var n=this;if(void 0===e&&(e="init"),this.runtime){var i="connect";this.eventsFlagMap.connect||(this.eventsMap.connect={},this.runtime.onConnect.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap.connect=!0),this.eventsMap.connect[e]=t}},t.prototype.removeConnect=function(t){var e=this;if(this.runtime){var n="connect";this.removeEventFunction(n,t)||(this.runtime.onConnect.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap.connect=!1)}},t.prototype.onConnectExternal=function(t,e){var n=this;if(void 0===e&&(e="init"),this.runtime){var i="connectExternal";this.eventsFlagMap[i]||(this.eventsMap[i]={},this.runtime.onConnectExternal.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t}},t.prototype.removeConnectExternal=function(t){var e=this;if(this.runtime){var n="connectExternal";this.removeEventFunction(n,t)||(this.runtime.onConnectExternal.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap[n]=!1)}},t.prototype.onCommand=function(t,e){var n=this;if(void 0===e&&(e="init"),this.commands){var i="command";this.eventsFlagMap.command||(this.eventsMap.command={},this.commands.onCommand.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap.command=!0),this.eventsMap.command[e]=t}},t.prototype.removeCommand=function(t){var e=this;if(this.runtime){var n="command";this.removeEventFunction(n,t)||(this.runtime.onConnectExternal.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap.command=!1)}},t}()),i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function o(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function r(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{u(i.next(t))}catch(t){r(t)}}function a(t){try{u(i.throw(t))}catch(t){r(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))}function s(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}var a,u,c,h=function(e,n){return t.createHash(e).update(String(n)).digest("hex")},l=function(e,n,i,o){void 0===i&&(i="sha256"),void 0===o&&(o=!0);var r=t.createHmac(i,n);return r.update(e),o?r.digest("hex"):r.digest()},f=function(e,n){e=String(e);var i=h("md5",n),o=t.randomBytes(16),r=t.createCipheriv("aes-256-cbc",Buffer.from(i),o),s=r.update(e);s=Buffer.concat([s,r.final()]);var a=l(s,i,"sha256",!1);return Buffer.concat([o,a,s]).toString("base64")},d=function(e,n){e=String(e);var i=h("md5",n),o=Buffer.from(e,"base64"),r=Buffer.from(o.slice(0,16));o=o.slice(48);var s=t.createDecipheriv("aes-256-cbc",Buffer.from(i),r),a=s.update(o);return(a=Buffer.concat([a,s.final()])).toString()},v={Hash:h,HashHmac:l,encryptData:f,decryptData:d},p=Object.freeze({__proto__:null,Hash:h,HashHmac:l,encryptData:f,decryptData:d,default:v});!function(t){t.SUCCESS="SUCCESS",t.ERROR="ERROR",t.WARNING="WARNING",t.DENIED="DENIED"}(a||(a={})),function(t){t.LOCALSTORAGE="localStorage",t.LOCAL="local",t.SYNC="sync"}(u||(u={})),function(t){t.LOCAL="LOCAL",t.BRWOSER="BRWOSER"}(c||(c={}));var m=!1,y=new(function(t){function e(){var e=t.call(this)||this;e.setMaxListeners(100),e.storageType=c.BRWOSER,e.supportStorage=!0;try{e.changeType(u.LOCAL)}catch(t){e.changeType(u.LOCALSTORAGE)}return e}return o(e,t),e.prototype.changeType=function(t){var e=this;if(!this.supportStorage)return this.storageType=c.LOCAL,this.storage=localStorage,this;try{t==u.LOCALSTORAGE?(this.storageType=c.LOCAL,this.storage=localStorage):t==u.SYNC?(this.storageType=c.BRWOSER,this.storage=chrome.storage.sync):t==u.LOCAL&&(this.storageType=c.BRWOSER,this.storage=chrome.storage.local),this.storageType==c.BRWOSER&&(m||(m=!0,chrome.storage.onChanged.addListener((function(t){e.emit("change",t)}))))}catch(t){}return this.emit("changeType",this.storageType),this},e.prototype.save=function(t,e){var n=this;return new Promise((function(i){var o;if(n.storageType==c.LOCAL)n.storage.setItem(t,e),n.emit("save",{key:t,val:e}),i();else{var r=""+t;n.storage.set(((o={})[r]=e,o),(function(){n.emit("save",{key:r,val:e}),i()}))}}))},e.prototype.load=function(t){var e=this;return new Promise((function(n){if(e.storageType==c.LOCAL){var i=e.storage.getItem(t)||null;n(i),e.emit("load",{key:t,val:i})}else{var o=""+t;e.storage.get([o],(function(t){try{e.emit("load",{key:o,val:t[o]}),n(t[o])}catch(t){n(void 0)}}))}}))},e.prototype.remove=function(t){var e=this;return new Promise((function(n){if(e.storageType==c.LOCAL)e.emit("remove",{key:t}),n(e.storage.removeItem(t)||null);else{var i=""+t;e.storage.remove([i],(function(t){try{e.emit("remove",{key:i}),n(t[i])}catch(t){n(void 0)}}))}}))},e.prototype.loadRemove=function(t){var e=this;return new Promise((function(n){return r(e,void 0,void 0,(function(){var e;return s(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.load(t)];case 1:return e=i.sent(),[4,this.remove(t)];case 2:return i.sent(),n(e),[3,4];case 3:throw i.sent();case 4:return[2]}}))}))}))},e}(e.EventEmitter)),w=function(t,e,n){return void 0===e&&(e=""),void 0===n&&(n=null),{result:t,msg:e,data:n}},g=function(t,e){var n;void 0===e&&(e=!0);for(var i="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_"+(e?"":"0123456789"),r=o.length,s=0;s<t;s++)i+=o.charAt(Math.floor(Math.random()*r));if(e){for(var a=(i+=String(Date.now())).split(""),u=a.length-1;u>0;u--){var c=Math.floor(Math.random()*(u+1));n=[a[c],a[u]],a[u]=n[0],a[c]=n[1]}i=a.join("")}return i},_=function(t,e){return r(void 0,void 0,void 0,(function(){var n,i,o,r,a,u,c,l,d;return s(this,(function(s){switch(s.label){case 0:n=h("sha256",Math.random()+Date.now()),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,y.save("blockdata:"+t,n)];case 2:return s.sent(),[3,4];case 3:throw s.sent();case 4:for((i={}).isEncrypt=!0,o=0,r=Object.entries(e);o<r.length;o++)a=r[o],u=a[0],c=a[1],l=!0,d=c,"object"==typeof c||Array.isArray(c)?c=JSON.stringify(c):"boolean"==typeof c&&(l=!1,d=c),l&&(d=f(c,n)),i[u]=d;return[2,i]}}))}))},b=function(t,e){return r(void 0,void 0,void 0,(function(){var n,i,o,r,a,u,c,h;return s(this,(function(s){switch(s.label){case 0:n=null,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,y.loadRemove("blockdata:"+t)];case 2:return n=s.sent(),[3,4];case 3:throw s.sent();case 4:if(!n)throw new Error("BrowserExt: Not found port crypt");for(i={},o=0,r=Object.entries(e);o<r.length;o++){a=r[o],u=a[0],("object"==typeof(c=a[1])||Array.isArray(c))&&(c=JSON.stringify(c));try{h=d(c,n);try{i[u]=JSON.parse(h)}catch(t){i[u]=h}}catch(t){i[u]=c}}return[2,i||null]}}))}))},M=new(function(){function t(){this.runtime=chrome.runtime||null,this.tabs=chrome.tabs||null}return t.prototype.send=function(t,e,n){var i=this;return void 0===e&&(e={}),void 0===n&&(n=!1),new Promise((function(o,a){return r(i,void 0,void 0,(function(){var i,r,u;return s(this,(function(s){switch(s.label){case 0:if(!this.runtime)return[2,a()];s.label=1;case 1:return s.trys.push([1,4,,5]),i="s:"+t+g(6),r=e,n?[4,_(i,e)]:[3,3];case 2:r=s.sent(),s.label=3;case 3:return this.runtime.sendMessage({__id__:i,method:t,param:r},(function(t){if(t&&t.result&&"SUCCESS"!=t.result)return a(t);o(t)})),[3,5];case 4:return u=s.sent(),a(u),[3,5];case 5:return[2]}}))}))}))},t.prototype.sendTab=function(t,e,n,i){return void 0===n&&(n={}),void 0===i&&(i=!1),r(this,void 0,void 0,(function(){var o=this;return s(this,(function(a){return[2,new Promise((function(a,u){return r(o,void 0,void 0,(function(){var o,r,c;return s(this,(function(s){switch(s.label){case 0:if(!this.tabs)return[2,u()];s.label=1;case 1:return s.trys.push([1,4,,5]),o="s:"+e+g(6),r=n,i&&n?[4,_(o,n)]:[3,3];case 2:r=s.sent(),s.label=3;case 3:return this.tabs.sendMessage(t,{__id__:o,method:e,param:r},(function(t){if(t&&"SUCCESS"!=t.result)return u(t);a(t)})),[3,5];case 4:return c=s.sent(),u(c),[3,5];case 5:return[2]}}))}))}))]}))}))},t.prototype.on=function(t,e){var n=this;if(void 0===e&&(e=""),!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;e.length<1&&(e=this.runtime.id);var i=function(i,o,a){var u=i.__id__||null,c=i.method||null,h=i.param||{};if(e&&o.id!=e)return!0;try{var l=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),a({result:t,msg:e,data:n})},f=h;if(h&&"object"==typeof h&&!0===h.isEncrypt){r(n,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,b(u||0,h)];case 1:return f=e.sent(),[3,3];case 2:return e.sent(),[2,!1];case 3:return t({method:c,sender:o,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else t({method:c,sender:o,oriParam:i,param:f,sendResult:l})}catch(t){}return!0};return this.runtime.onMessage.addListener(i),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onMessage.removeListener(i)}}},t.prototype.onExternal=function(t,e){var n=this;if(void 0===e&&(e=""),!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;e.length<1&&(e=this.runtime.id);var i=function(i,o,a){var u=i.__id__||null,c=i.method||null,h=i.param;if(e&&o.id!=e)return!0;try{var l=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),a({result:t,msg:e,data:n})},f=h;if(h&&"object"==typeof h&&!0===h.isEncrypt){r(n,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,b(u||0,h)];case 1:return f=e.sent(),[3,3];case 2:throw e.sent();case 3:return t({method:c,sender:o,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else t({method:c,sender:o,oriParam:i,param:f,sendResult:l})}catch(t){}return!0};return this.runtime.onMessageExternal.addListener(i),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onMessageExternal.removeListener(i)}}},t}()),R=new(function(){function t(){this.__id__=0,this.__timeout__=24e4,this.portMap={},this.runtime=chrome.runtime||null}return t.prototype.setTimeout=function(t){return void 0===t&&(t=24e4),this.__timeout__=t,this},t.prototype.connect=function(t){var e=this;if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;if(this.portMap[t])return this.portMap[t];var n=this.runtime.connect({name:t});this.portMap[t]=n;var i=function(){var n=e.portMap[t];delete e.portMap[t],n.onDisconnect.removeListener(i)};return n.onDisconnect.addListener(i),n},t.prototype.disConnect=function(t){if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),!1;if(this.portMap[t]){var e=this.portMap[t]||null;e&&e.disconnect()}return!0},t.prototype.onDisconnect=function(t,e){if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),this;if(!this.portMap[t])return this;var n=this.portMap[t];return n?(n.onDisconnect.addListener(e),this):this},t.prototype.send=function(t,e,n,i,o){return void 0===n&&(n={}),void 0===i&&(i=!1),void 0===o&&(o=null),r(this,void 0,void 0,(function(){var r,u,c,h,l;return s(this,(function(s){switch(s.label){case 0:if(!(r=this.connect(t)))return console.warn('BrowserExt: Not found connect port name "'+t+'"'),[2];s.label=1;case 1:return s.trys.push([1,4,,5]),this.__id__++,this.__id__>1e9&&(this.__id__=1),u=this.__id__,c=n,i?[4,_(u,n)]:[3,3];case 2:c=s.sent(),s.label=3;case 3:return null!=o&&(h=!1,l=function(n){r&&n.name&&n.name==t&&n.__id__&&n.__id__==u&&n.method==e&&(r.onMessage.removeListener(l),null!=o&&(h=!0,o(n)))},r.onMessage.addListener(l),setTimeout((function(){r&&(h||o({__id__:u,name:t,method:e,result:a.ERROR,msg:"Return failure due to timeout",data:null}),r.onMessage.removeListener(l))}),this.__timeout__)),r.postMessage({__id__:u,name:t,method:e,param:c}),[3,5];case 4:throw s.sent();case 5:return[2]}}))}))},t.prototype.on=function(t,e){var n=this;if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;t.length<1&&(t="*");var i=function(i,o){var u=i.__id__||null,c=i.method||null,h=i.param,l=function(e,n,i){if(void 0===e&&(e=a.SUCCESS),void 0===n&&(n=null),void 0===i&&(i=null),o&&o.postMessage){var r={name:t,method:c,result:e,msg:n,data:i};null!=u&&(r.__id__=u),o.postMessage(r)}},f=h;if(h&&"object"==typeof h&&!0===h.isEncrypt){r(n,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,b(u||0,h)];case 1:return f=t.sent(),[3,3];case 2:throw t.sent();case 3:return e({port:o,method:c,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else e({port:o,method:c,oriParam:i,param:f,sendResult:l});return!0},o=function(e){if("*"!=t&&e.name!=t)return!0;e.onDisconnect.addListener((function(){e.onMessage.removeListener(i),n.portMap[t]=null})),e.onMessage.addListener(i)};return this.runtime.onConnect.addListener(o),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onConnect.removeListener(o)}}},t}()),E=new(function(){function t(){this.notify=chrome.notifications,this.notifyMap={}}return t.prototype.setupNotifyOption=function(t){this.notifyMap[t]||(this.notifyMap[t]={options:{},clicked:null,closed:null,buttonClicked:null,showSettings:null,permissionChanged:null})},t.prototype.setOptions=function(t,e){if(void 0===e&&(e={}),!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");return this.setupNotifyOption(t),this.notifyMap[t].options=Object.assign({},{type:"basic"},e),this},t.prototype.onClicked=function(t,e){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].clicked&&this.removeClicked(t),this.notifyMap[t].clicked=function(n){n==t&&e(t)};var n=this.notifyMap[t].clicked;return null!=n&&this.notify.onClicked.addListener(n),this},t.prototype.removeClicked=function(t){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].clicked;return null!=e&&(this.notify.onClicked.removeListener(e),this.notifyMap[t].clicked=null),this},t.prototype.onClosed=function(t,e){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].closed&&this.removeClosed(t),this.notifyMap[t].closed=function(n,i){n==t&&e(n,i)};var n=this.notifyMap[t].closed;return null!=n&&this.notify.onClosed.addListener(n),this},t.prototype.removeClosed=function(t){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].closed;return null!=e&&(this.notify.onClosed.removeListener(e),this.notifyMap[t].closed=null),this},t.prototype.onButtonClicked=function(t,e){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].buttonClicked&&this.removeButtonClicked(t),this.notifyMap[t].buttonClicked=function(n,i){n==t&&e(n,i)};var n=this.notifyMap[t].buttonClicked;return null!=n&&this.notify.onButtonClicked.addListener(n),this},t.prototype.removeButtonClicked=function(t){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].buttonClicked;return null!=e&&(this.notify.onButtonClicked.removeListener(e),this.notifyMap[t].buttonClicked=null),this},t.prototype.onPermissionChanged=function(t,e){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].permissionChanged&&this.removePermissionChanged(t),this.notifyMap[t].permissionChanged=e;var n=this.notifyMap[t].permissionChanged;return null!=n&&this.notify.onPermissionLevelChanged.addListener(n),this},t.prototype.removePermissionChanged=function(t){if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].permissionChanged;return null!=e&&(this.notify.onPermissionLevelChanged.removeListener(e),this.notifyMap[t].permissionChanged=null),this},t.prototype.create=function(t,e){var n=this;if(void 0===e&&(e={}),!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");return new Promise((function(i){var o=Object.assign({},e);n.notifyMap[t]&&n.notifyMap[t].options&&(o=Object.assign(o,n.notifyMap[t].options)),n.notify.create(t,o,(function(t){i(t)}))}))},t.prototype.update=function(t,e){var n=this;if(void 0===e&&(e={}),!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");return new Promise((function(i){var o=Object.assign({},e);n.notifyMap[t]&&n.notifyMap[t].options&&(o=Object.assign(o,n.notifyMap[t].options)),n.notify.update(t,o,(function(t){i(t)}))}))},t.prototype.getAll=function(){var t=this;if(!this.notify)throw w(a.ERROR,"Not found chrome.notifications.");return new Promise((function(e){t.notify.getAll(e)}))},t}()),O=new(function(){function t(){this.alarm=chrome.alarms||null,this.eventMap={}}return t.prototype.create=function(t,e){if(!this.alarm)throw w(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw w(a.ERROR,"Not found alarm name.");return this.alarm.create(t,e),this.eventMap[t]={},this},t.prototype.addListener=function(t,e){var n=this;if(!this.alarm)throw w(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw w(a.ERROR,"Not found alarm name.");var i=g(5);return this.eventMap[t]||(this.eventMap[t]={}),Object.keys(this.eventMap[t]).length<1&&this.alarm.onAlarm.addListener((function(e){if(e.name==t&&n.eventMap[t])for(var i=0,o=Object.entries(n.eventMap[t]);i<o.length;i++){var r=o[i],s=r[0];(0,r[1])(s,e)}})),this.eventMap[t][i]=e,this},t.prototype.removeListener=function(t,e){if(!this.alarm)throw w(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw w(a.ERROR,"Not found alarm name.");return this.eventMap[t]&&(Object.keys(this.eventMap[t]).length<2?this.removeListeners(t):this.eventMap[t][e]&&delete this.eventMap[t][e]),this},t.prototype.removeListeners=function(t){var e=this;if(!this.alarm)throw w(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw w(a.ERROR,"Not found alarm name.");return this.eventMap[t]&&delete this.eventMap[t],this.alarm.onAlarm.removeListener((function(n){if(n.name==t&&e.eventMap[t])for(var i=0,o=Object.entries(e.eventMap[t]);i<o.length;i++){var r=o[i],s=r[0];(0,r[1])(s,n)}})),this},t.prototype.clear=function(t){if(!this.alarm)throw w(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw w(a.ERROR,"Not found alarm name.");return this.removeListeners(t),this.alarm.clear(t),this},t.prototype.clearAll=function(){if(!this.alarm)throw w(a.ERROR,"Not found chrome.alarm.");var t=Object.keys(this.eventMap)||[];if(t.length>0)for(var e=0,n=t;e<n.length;e++){var i=n[e];this.clear(i)}return this.alarm.clearAll(),this},t}());function L(t){var e="",n=null;if(t&&t.url){var i=(t.url||"").split("/");e=i[2]||"",n=(i.slice(0,3)||[]).join("/")}return{id:t.id||null,index:t.index,status:t.status||null,title:t.title||null,host:e,origin:n,favIcon:t.favIconUrl||null,windowId:t.windowId}}var C,N={tab:null,info:null},A=function(t){function e(){var e=t.call(this)||this;return e.setMaxListeners(100),e.tabs=chrome.tabs||null,e.activeId=null,e.tabItems={},e.eventsFlagMap={},e.eventsMap={},e.init(),e}return o(e,t),e.prototype.init=function(){var t=this;this.tabs&&this.tabs.query({},(function(e){e.map((function(e){if(null!=e){e.active&&(t.activeId=e.id||null);var n=L(e);e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n})}}))})),this.onActivated((function(e,n){null!=e&&(e.active&&(t.activeId=e.id||null),e.id&&(null!=n&&(t.tabItems[e.id]=n),e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n})))}),"___MTC_init___"),this.onUpdated((function(e,n){null!=e&&("loading"!=e.status&&(e.active&&(t.activeId=e.id||null),e.id&&(t.tabItems[e.id]||{origin:null}).origin!=n.origin&&(null!=n&&(t.tabItems[e.id]=n),e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n}))))}),"___MTC_init___"),this.onRemoved((function(e){try{t.tabItems[e]&&(t.emit("remove",{info:t.tabItems[e]}),delete t.tabItems[e])}catch(t){}}),"___MTC_init___"),this.getActiveTab().then((function(e){var n=e.tab,i=e.info;null!=n&&(n.active&&(t.activeId=n.id||null),n.id&&(null!=i&&(t.tabItems[n.id]=i),n.active&&t.emit("active",{tab:n,info:i}),t.emit("change",{tab:n,info:i})))}))},e.prototype.getInfo=function(t){return L(t)},e.prototype.getTab=function(t){var e=this;return new Promise((function(n,i){if(!e.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),i(N);try{try{e.tabs.get(t,(function(t){var e=L(t);n({tab:t,info:e})}))}catch(t){i(t)}}catch(t){i(t)}}))},e.prototype.getTabIndex=function(t,e){var n=this;return void 0===t&&(t=0),void 0===e&&(e=null),new Promise((function(i,o){if(!n.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),o(N);try{n.getTabs(e).then((function(e){if(!n.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),o(N);try{if(null==e)return i(N);if(null==e[t])return i(N);var r=(e[t].tab||{id:null}).id||null;if(null==r)return i(N);n.tabs.get(r,(function(t){var e=L(t);i({tab:t,info:e})}))}catch(t){o(t)}})).catch((function(t){o(t)}))}catch(t){o(t)}}))},e.prototype.getActiveTab=function(t){return void 0===t&&(t=0),r(this,void 0,void 0,(function(){var e;return s(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.getTabIndex(t,{active:!0})];case 1:return[2,n.sent()];case 2:return e=n.sent(),console.warn("BrowserExt: "+e.message||e),[2,{tab:null,info:null}];case 3:return[2]}}))}))},e.prototype.getItems=function(){var t=this;return new Promise((function(e){setTimeout((function(){for(var n={},i=0,o=Object.entries(t.tabItems);i<o.length;i++){var r=o[i],s=r[0],a=r[1];n[s]={info:a}}return e(n)}),100)}))},e.prototype.getActiveItem=function(){var t=this;return new Promise((function(e){setTimeout((function(){if(!t.activeId)return e(null);if(!t.tabItems[t.activeId])return e(null);var n=t.tabItems[t.activeId]||{};return e({tab:null,info:n})}),100)}))},e.prototype.getTabs=function(t){var e=this;return void 0===t&&(t=null),new Promise((function(n,i){if(!e.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),i(null);null==t&&(t={active:!0});try{e.tabs.query(t,(function(t){var e=[];t.map((function(t){var n=L(t);e.push({tab:t,info:n})})),n(e)}))}catch(t){i(t)}}))},e.prototype.onActivated=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;var i="activated";return this.eventsFlagMap[i]||(this.eventsMap[i]={},this.tabs.onActivated.addListener((function(t){n.tabs&&n.tabs.get(t.tabId,(function(t){try{var e=L(t);(Object.values(n.eventsMap[i])||[]).map((function(n){n(t,e)}))}catch(t){}}))})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t,this},e.prototype.removeActivated=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;var e="activated";if(!this.eventsFlagMap[e])return this;if(!this.eventsMap[e][t])return this;if("*"==t)for(var n=0,i=Object.entries(this.eventsMap[e]);n<i.length;n++){var o=i[n],r=o[0];o[1],"___MTC_init___"!=r&&delete this.eventsMap[e][r]}else delete this.eventsMap[e][t];return this},e.prototype.onUpdated=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;return this.eventsFlagMap.updated||(this.eventsMap.updated={},this.tabs.onUpdated.addListener((function(t,e,i){if(n.tabs&&i)try{var o=L(i);(Object.values(n.eventsMap.updated)||[]).map((function(t){t(i,o)}))}catch(t){}})),this.eventsFlagMap.updated=!0),this.eventsMap.updated[e]=t,this},e.prototype.removeUpdated=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;if(!this.eventsFlagMap.updated)return this;if(!this.eventsMap.updated[t])return this;if("*"==t)for(var e=0,n=Object.entries(this.eventsMap.updated);e<n.length;e++){var i=n[e],o=i[0];i[1],"___MTC_init___"!=o&&delete this.eventsMap.updated[o]}else delete this.eventsMap.updated[t];return this},e.prototype.onRemoved=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;return this.eventsFlagMap.removed||(this.eventsMap.removed={},this.tabs.onRemoved.addListener((function(t){n.tabs&&(Object.values(n.eventsMap.removed)||[]).map((function(e){e(t)}))})),this.eventsFlagMap.removed=!0),this.eventsMap.removed[e]=t,this},e.prototype.removeRemoved=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;if(!this.eventsFlagMap.removed)return this;if(!this.eventsMap.removed[t])return this;if("*"==t)for(var e=0,n=Object.entries(this.eventsMap.removed);e<n.length;e++){var i=n[e],o=i[0];i[1],"___MTC_init___"!=o&&delete this.eventsMap.removed[o]}else delete this.eventsMap.removed[t];return this},e}(e.EventEmitter),S=!1,T=new(function(t){function e(){var e=t.call(this)||this;e.setMaxListeners(100),e.storageType=c.BRWOSER,e.supportStorage=!0;try{e.changeType(u.LOCAL)}catch(t){e.changeType(u.LOCALSTORAGE)}return e}return o(e,t),e.prototype.changeType=function(t){var e=this;if(!this.supportStorage)return this.storageType=c.LOCAL,this.storage=localStorage,this;try{t==u.LOCALSTORAGE?(this.storageType=c.LOCAL,this.storage=localStorage):t==u.SYNC?(this.storageType=c.BRWOSER,this.storage=chrome.storage.sync):t==u.LOCAL&&(this.storageType=c.BRWOSER,this.storage=chrome.storage.local),this.storageType==c.BRWOSER&&(S||(S=!0,chrome.storage.onChanged.addListener((function(t){e.emit("change",t)}))))}catch(t){}return this.emit("changeType",this.storageType),this},e.prototype.save=function(t,e){var n=this;return new Promise((function(i){var o;if(n.storageType==c.LOCAL)n.storage.setItem(t,e),n.emit("save",{key:t,val:e}),i();else{var r=""+t;n.storage.set(((o={})[r]=e,o),(function(){n.emit("save",{key:r,val:e}),i()}))}}))},e.prototype.load=function(t){var e=this;return new Promise((function(n){if(e.storageType==c.LOCAL){var i=e.storage.getItem(t)||null;n(i),e.emit("load",{key:t,val:i})}else{var o=""+t;e.storage.get([o],(function(t){try{e.emit("load",{key:o,val:t[o]}),n(t[o])}catch(t){n(void 0)}}))}}))},e.prototype.remove=function(t){var e=this;return new Promise((function(n){if(e.storageType==c.LOCAL)e.emit("remove",{key:t}),n(e.storage.removeItem(t)||null);else{var i=""+t;e.storage.remove([i],(function(t){try{e.emit("remove",{key:i}),n(t[i])}catch(t){n(void 0)}}))}}))},e.prototype.loadRemove=function(t){var e=this;return new Promise((function(n){return r(e,void 0,void 0,(function(){var e;return s(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.load(t)];case 1:return e=i.sent(),[4,this.remove(t)];case 2:return i.sent(),n(e),[3,4];case 3:throw i.sent();case 4:return[2]}}))}))}))},e}(e.EventEmitter)),k={},x={},I=new(function(t){function e(){var e=t.call(this)||this;return e.setMaxListeners(100),e.window=chrome.windows||null,e.isAddEvent=!1,e}return o(e,t),e.prototype.get=function(t){if(!this.window)throw w(a.ERROR,"Not found chrome.windows.");return x[t]||null},e.prototype.getId=function(t,e){if(!this.window)throw w(a.ERROR,"Not found chrome.windows.");this.window.get(t,(function(t){e(t)}))},e.prototype.getAll=function(t){if(!this.window)throw w(a.ERROR,"Not found chrome.windows.");this.window.getAll(t)},e.prototype.open=function(t,e,n){var i=this;if(void 0===n&&(n=!1),!this.window)throw w(a.ERROR,"Not found chrome.windows.");if(Object.keys(e).length<1)throw w(a.ERROR,"Required create option");this.isAddEvent||(this.isAddEvent=!0,this.window.onRemoved.addListener((function(t){if(void 0!==t&&void 0!==k[t]){var e=k[t];void 0!==x[e._name]&&delete x[e._name],delete k[t],i.emit("remove",e)}}))),n&&void 0!==x[t]?(this.window.update(x[t].id,{focused:!0}),this.emit("update",k[x[t].id])):this.window.create(e,(function(e){void 0!==e&&(x[t]=e,k[e.id]=Object.assign({_name:t},e),i.emit("create",k[e.id]))}))},e.prototype.update=function(t,e,n){if(!this.window)throw w(a.ERROR,"Not found chrome.windows.");this.window.update(t,e,n)},e.prototype.close=function(t){var e=this;if(!this.window)throw w(a.ERROR,"Not found chrome.windows.");if(!t)throw w(a.ERROR,"Required window id");this.window.remove(t,(function(t){if(void 0!==t&&void 0!==k[t]){var n=k[t];void 0!==x[n._name]&&delete x[n._name],delete k[t],e.emit("remove",n)}}))},e}(e.EventEmitter));!function(t){t.LOAD="load",t.MESSAGE="message",t.REMOVE="remove"}(C||(C={}));var B=function(t){function e(e,n){var i=t.call(this)||this;return i.__id__=0,i.__timeout__=36e4,i.isRun=!1,i.replay=0,i.name=e,i.recvName=n||e,i}return o(e,t),e.prototype.shouldWindow=function(){return this.doctypeCheck()&&this.suffixCheck()&&this.documentElementCheck()},e.prototype.doctypeCheck=function(){var t=window.document.doctype;return!t||"html"===t.name},e.prototype.suffixCheck=function(){for(var t=[/\.xml$/u,/\.pdf$/u],e=window.location.pathname,n=0;n<t.length;n++)if(t[n].test(e))return!1;return!0},e.prototype.documentElementCheck=function(){var t=document.documentElement.nodeName;return!t||"html"===t.toLowerCase()},e.prototype.setupEvent=function(){return r(this,void 0,void 0,(function(){var t,e,n=this;return s(this,(function(i){return this.isRun?[2]:this.shouldWindow?(this.isRun=!0,t=function(t){n.emit("load",{name:n.name,data:null,event:t})},e=function(t){var e=t.data||{};if(e.name==n.name){var i=e.__id__||null,o=e.method||null;n.emit("message",{name:n.name,method:o,data:e.data,event:t,sendResult:function(e,o){window.postMessage({__id__:i,name:n.recvName,method:e,data:o||null},t.origin||window.origin||"*")}})}},window.addEventListener("load",t),window.addEventListener("message",e),window.addEventListener("unload",(function(i){window.removeEventListener("load",t),window.removeEventListener("message",e),n.emit("remove",{name:n.name,data:null,event:i})})),[2]):(this.replay++,setTimeout((function(){n.replay>10?console.warn("Metawallet: Not found window."):n.setupEvent()}),1e3),[2])}))}))},e.prototype.setTimeout=function(t){return void 0===t&&(t=36e4),this.__timeout__=t,this},e.prototype.send=function(t,e,n){var i=this;if(void 0===e&&(e={}),!this.isRun||!this.shouldWindow)throw new Error("DappSDK: Wait for connect.");this.__id__++,this.__id__>1e9&&(this.__id__=1);var o=this.__id__,r=window.origin||"*";try{if(null!=n){var s=!1,u=function(c){if(c.origin==r){var h=c.data||{};h.name==i.recvName&&h.__id__&&h.__id__==o&&h.method==t&&(window.removeEventListener("message",u),null!=n&&(s=!0,n({__id__:o,name:i.name,method:t,status:a.SUCCESS,msg:null,data:e||null})))}};window.addEventListener("message",u),setTimeout((function(){s||window.removeEventListener("message",u),n({__id__:o,name:i.name,method:t,status:a.ERROR,msg:"Connection timed out.",data:null})}),this.__timeout__)}window.postMessage({__id__:o,name:this.recvName,method:t,data:e},window.origin||"*")}catch(t){throw t}},e}(e.EventEmitter),F={runtime:n,message:M,port:R,alarms:O,notify:E,tabs:function(){return new A},storage:T,window:I,windowMessage:function(t,e){var n=new B(t,e);return n.setMaxListeners(100),n.setupEvent(),n},crypt:p};module.exports=F;
