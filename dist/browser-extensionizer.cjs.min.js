"use strict";var t=require("crypto"),e=require("events"),n=new(function(){function t(){return t.instance||(this.eventsFlagMap={},this.eventsMap={},this.runtime=chrome.runtime||null,this.commands=chrome.commands||null,t.instance=this),t.instance}return t.prototype.eventFunction=function(t,e){var n=this.eventsMap[t]||{};if(Object.keys(n).length>0)for(var i=0,r=Object.entries(n);i<r.length;i++){var o=r[i],s=o[0];(0,o[1])({key:s,data:e})}},t.prototype.removeEventFunction=function(t,e){if(this.eventsFlagMap[t]&&this.eventsMap[t][e])return"*"==e?(delete this.eventsMap[t],this.eventsMap[t]={}):delete this.eventsMap[t][e],Object.keys(this.eventsMap[t]).length<1},t.prototype.onInstalled=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.runtime)return console.warn("BrowserExt: Not support chrome.runtime");var i="installed";this.eventsFlagMap[i]||(this.eventsMap[i]={},this.runtime.onInstalled.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t},t.prototype.removeInstalled=function(t){var e=this;if(this.runtime){var n="installed";this.removeEventFunction(n,t)||(this.runtime.onInstalled.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap[n]=!1)}},t.prototype.onConnect=function(t,e){var n=this;if(void 0===e&&(e="init"),this.runtime){var i="connect";this.eventsFlagMap.connect||(this.eventsMap.connect={},this.runtime.onConnect.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap.connect=!0),this.eventsMap.connect[e]=t}},t.prototype.removeConnect=function(t){var e=this;if(this.runtime){var n="connect";this.removeEventFunction(n,t)||(this.runtime.onConnect.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap.connect=!1)}},t.prototype.onConnectExternal=function(t,e){var n=this;if(void 0===e&&(e="init"),this.runtime){var i="connectExternal";this.eventsFlagMap[i]||(this.eventsMap[i]={},this.runtime.onConnectExternal.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t}},t.prototype.removeConnectExternal=function(t){var e=this;if(this.runtime){var n="connectExternal";this.removeEventFunction(n,t)||(this.runtime.onConnectExternal.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap[n]=!1)}},t.prototype.onCommand=function(t,e){var n=this;if(void 0===e&&(e="init"),this.commands){var i="command";this.eventsFlagMap.command||(this.eventsMap.command={},this.commands.onCommand.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap.command=!0),this.eventsMap.command[e]=t}},t.prototype.removeCommand=function(t){var e=this;if(this.runtime){var n="command";this.removeEventFunction(n,t)||(this.runtime.onConnectExternal.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap.command=!1)}},t}()),i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function r(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function o(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))}function s(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var a,u,c,h=function(e,n){return t.createHash(e).update(String(n)).digest("hex")},l=function(e,n){e=String(e);var i=h("md5",n),r=t.randomBytes(16),o=t.createCipheriv("aes-256-cbc",Buffer.from(i),r),s=o.update(e),a=function(e,n,i,r){void 0===i&&(i="sha256"),void 0===r&&(r=!0);var o=t.createHmac(i,n);return o.update(e),r?o.digest("hex"):o.digest()}(s=Buffer.concat([s,o.final()]),i,"sha256",!1);return Buffer.concat([r,a,s]).toString("base64")},f=function(e,n){e=String(e);var i=h("md5",n),r=Buffer.from(e,"base64"),o=Buffer.from(r.slice(0,16));r=r.slice(48);var s=t.createDecipheriv("aes-256-cbc",Buffer.from(i),o),a=s.update(r);return(a=Buffer.concat([a,s.final()])).toString()};!function(t){t.SUCCESS="SUCCESS",t.ERROR="ERROR",t.WARNING="WARNING",t.DENIED="DENIED"}(a||(a={})),function(t){t.LOCALSTORAGE="localStorage",t.LOCAL="local",t.SYNC="sync"}(u||(u={})),function(t){t.LOCAL="LOCAL",t.BRWOSER="BRWOSER"}(c||(c={}));var p=!1,v=new(function(t){function e(){var n=this;if(!e.instance){(n=t.call(this)||this).storageType=c.BRWOSER,n.supportStorage=!0;try{n.changeType(u.LOCAL)}catch(t){n.changeType(u.LOCALSTORAGE)}e.instance=n}return e.instance}return r(e,t),e.prototype.changeType=function(t){var e=this;if(!this.supportStorage)return this.storageType=c.LOCAL,this.storage=localStorage,this;try{t==u.LOCALSTORAGE?(this.storageType=c.LOCAL,this.storage=localStorage):t==u.SYNC?(this.storageType=c.BRWOSER,this.storage=chrome.storage.sync):t==u.LOCAL&&(this.storageType=c.BRWOSER,this.storage=chrome.storage.local),this.storageType==c.BRWOSER&&(p||(p=!0,chrome.storage.onChanged.addListener((function(t){e.emit("change",t)}))))}catch(t){}return this.emit("changeType",this.storageType),this},e.prototype.save=function(t,e){var n=this;return new Promise((function(i){var r;if(n.storageType==c.LOCAL)n.storage.setItem(t,e),n.emit("save",{key:t,val:e}),i();else{var o=""+t;n.storage.set(((r={})[o]=e,r),(function(){n.emit("save",{key:o,val:e}),i()}))}}))},e.prototype.load=function(t){var e=this;return new Promise((function(n){if(e.storageType==c.LOCAL){var i=e.storage.getItem(t)||null;n(i),e.emit("load",{key:t,val:i})}else{var r=""+t;e.storage.get([r],(function(t){try{e.emit("load",{key:r,val:t[r]}),n(t[r])}catch(t){n(void 0)}}))}}))},e.prototype.remove=function(t){var e=this;return new Promise((function(n){if(e.storageType==c.LOCAL)e.emit("remove",{key:t}),n(e.storage.removeItem(t)||null);else{var i=""+t;e.storage.remove([i],(function(t){try{e.emit("remove",{key:i}),n(t[i])}catch(t){n(void 0)}}))}}))},e.prototype.loadRemove=function(t){var e=this;return new Promise((function(n){return o(e,void 0,void 0,(function(){var e;return s(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.load(t)];case 1:return e=i.sent(),[4,this.remove(t)];case 2:return i.sent(),n(e),[3,4];case 3:throw i.sent();case 4:return[2]}}))}))}))},e}(e.EventEmitter));v.setMaxListeners(100);var d=function(t,e,n){return void 0===e&&(e=""),void 0===n&&(n=null),{result:t,msg:e,data:n}},m=function(t,e){var n;void 0===e&&(e=!0);for(var i="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_"+(e?"":"0123456789"),o=r.length,s=0;s<t;s++)i+=r.charAt(Math.floor(Math.random()*o));if(e){for(var a=(i+=String(Date.now())).split(""),u=a.length-1;u>0;u--){var c=Math.floor(Math.random()*(u+1));n=[a[c],a[u]],a[u]=n[0],a[c]=n[1]}i=a.join("")}return i},y=function(t,e){return o(void 0,void 0,void 0,(function(){var n,i,r,o,a,u,c,f,p;return s(this,(function(s){switch(s.label){case 0:n=h("sha256",Math.random()+Date.now()),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,v.save("cryptMsg:"+t,n)];case 2:return s.sent(),[3,4];case 3:throw s.sent();case 4:for((i={}).isEncrypt=!0,r=0,o=Object.entries(e);r<o.length;r++)a=o[r],u=a[0],c=a[1],f=!0,p=c,"object"==typeof c||Array.isArray(c)?c=JSON.stringify(c):"boolean"==typeof c&&(f=!1,p=c),f&&(p=l(c,n)),i[u]=p;return[2,i]}}))}))},g=function(t,e){return o(void 0,void 0,void 0,(function(){var n,i,r,o,a,u,c,h;return s(this,(function(s){switch(s.label){case 0:n=null,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,v.loadRemove("cryptMsg:"+t)];case 2:return n=s.sent(),[3,4];case 3:throw s.sent();case 4:if(!n)throw new Error("BrowserExt: Not found port cryptMSg");for(i={},r=0,o=Object.entries(e);r<o.length;r++){a=o[r],u=a[0],("object"==typeof(c=a[1])||Array.isArray(c))&&(c=JSON.stringify(c));try{h=f(c,n);try{i[u]=JSON.parse(h)}catch(t){i[u]=h}}catch(t){i[u]=c}}return[2,i||null]}}))}))},M=new(function(){function t(){return t.instance||(this.runtime=chrome.runtime||null,this.tabs=chrome.tabs||null,t.instance=this),t.instance}return t.prototype.send=function(t,e,n){var i=this;return void 0===e&&(e={}),void 0===n&&(n=!1),new Promise((function(r,a){return o(i,void 0,void 0,(function(){var i,o,u;return s(this,(function(s){switch(s.label){case 0:if(!this.runtime)return[2,a()];s.label=1;case 1:return s.trys.push([1,4,,5]),i="s:"+t+m(6),o=e,n?[4,y(i,e)]:[3,3];case 2:o=s.sent(),s.label=3;case 3:return this.runtime.sendMessage({__id__:i,method:t,param:o},(function(t){if(t&&t.result&&"SUCCESS"!=t.result)return a(t);r(t)})),[3,5];case 4:return u=s.sent(),a(u),[3,5];case 5:return[2]}}))}))}))},t.prototype.sendTab=function(t,e,n,i){return void 0===n&&(n={}),void 0===i&&(i=!1),o(this,void 0,void 0,(function(){var r=this;return s(this,(function(a){return[2,new Promise((function(a,u){return o(r,void 0,void 0,(function(){var r,o,c;return s(this,(function(s){switch(s.label){case 0:if(!this.tabs)return[2,u()];s.label=1;case 1:return s.trys.push([1,4,,5]),r="s:"+e+m(6),o=n,i?[4,y(r,n)]:[3,3];case 2:o=s.sent(),s.label=3;case 3:return this.tabs.sendMessage(t,{__id__:r,method:e,param:o},(function(t){if(t&&"SUCCESS"!=t.result)return u(t);a(t)})),[3,5];case 4:return c=s.sent(),u(c),[3,5];case 5:return[2]}}))}))}))]}))}))},t.prototype.on=function(t,e){var n=this;if(void 0===e&&(e=""),!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;e.length<1&&(e=this.runtime.id);var i=function(i,r,a){var u=i.__id__||null,c=i.method||null,h=i.param||{};if(e&&r.id!=e)return!0;try{var l=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),a({result:t,msg:e,data:n})},f=h;if(!0===h.isEncrypt){o(n,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,g(u||0,h)];case 1:return f=e.sent(),[3,3];case 2:throw e.sent();case 3:return t({method:c,sender:r,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else t({method:c,sender:r,oriParam:i,param:f,sendResult:l})}catch(t){}return!0};return this.runtime.onMessage.addListener(i),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onMessage.removeListener(i)}}},t.prototype.onExternal=function(t,e){var n=this;if(void 0===e&&(e=""),!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;e.length<1&&(e=this.runtime.id);var i=function(i,r,a){var u=i.__id__||null,c=i.method||null,h=i.param||{};if(e&&r.id!=e)return!0;try{var l=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),a({result:t,msg:e,data:n})},f=h;if(!0===h.isEncrypt){o(n,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,g(u||0,h)];case 1:return f=e.sent(),[3,3];case 2:throw e.sent();case 3:return t({method:c,sender:r,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else t({method:c,sender:r,oriParam:i,param:f,sendResult:l})}catch(t){}return!0};return this.runtime.onMessageExternal.addListener(i),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onMessageExternal.removeListener(i)}}},t}()),b=new(function(){function t(){return t.instance||(this.__id__=0,this.__timeout__=24e4,this.portMap={},this.runtime=chrome.runtime||null,t.instance=this),t.instance}return t.prototype.setTimeout=function(t){return void 0===t&&(t=24e4),this.__timeout__=t,this},t.prototype.connect=function(t){var e=this;if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;if(this.portMap[t])return this.portMap[t];var n=this.runtime.connect({name:t});this.portMap[t]=n;var i=function(){var n=e.portMap[t];delete e.portMap[t],n.onDisconnect.removeListener(i)};return n.onDisconnect.addListener(i),n},t.prototype.disConnect=function(t){if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),!1;if(this.portMap[t]){var e=this.portMap[t]||null;e&&e.disconnect()}return!0},t.prototype.onDisconnect=function(t,e){if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),this;if(!this.portMap[t])return this;var n=this.portMap[t];return n?(n.onDisconnect.addListener(e),this):this},t.prototype.send=function(t,e,n,i,r){return void 0===n&&(n={}),void 0===i&&(i=!1),void 0===r&&(r=null),o(this,void 0,void 0,(function(){var o,u,c,h,l;return s(this,(function(s){switch(s.label){case 0:if(!(o=this.connect(t)))return console.warn('BrowserExt: Not found connect port name "'+t+'"'),[2];s.label=1;case 1:return s.trys.push([1,4,,5]),this.__id__++,this.__id__>1e9&&(this.__id__=1),u=this.__id__,c=n,i?[4,y(u,n)]:[3,3];case 2:c=s.sent(),s.label=3;case 3:return null!=r&&(h=!1,l=function(n){o&&n.name&&n.name==t&&n.__id__&&n.__id__==u&&n.method==e&&(o.onMessage.removeListener(l),null!=r&&(h=!0,r(n)))},o.onMessage.addListener(l),setTimeout((function(){o&&(h||r({__id__:u,name:t,method:e,result:a.ERROR,msg:"Return failure due to timeout",data:null}),o.onMessage.removeListener(l))}),this.__timeout__)),o.postMessage({__id__:u,name:t,method:e,param:c}),[3,5];case 4:throw s.sent();case 5:return[2]}}))}))},t.prototype.on=function(t,e){var n=this,i=this.connect(t);if(i){var r=-1,u=function(u,c){var h=u.__id__||null,l=u.method||null,f=u.param||{};if(null!=h)if(h>1e9||h-r<0)r=0;else{if(r>0&&r>=h)return;r=h}var p=function(e,n,i){if(void 0===e&&(e=a.SUCCESS),void 0===n&&(n=null),void 0===i&&(i=null),c&&c.postMessage){var r={name:t,method:l,result:e,msg:n,data:i};null!=h&&(r.__id__=h),c.postMessage(r)}},v=f;if(!0===f.isEncrypt){o(n,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,g(h||0,f)];case 1:return v=t.sent(),[3,3];case 2:throw t.sent();case 3:return e({port:i,method:l,oriParam:u,param:v,sendResult:p}),[2]}}))}))}else e({port:i,method:l,oriParam:u,param:v,sendResult:p});return!0};return i.onMessage.addListener(u),{removeListener:function(){null==i||i.onMessage.removeListener(u)}}}console.warn('BrowserExt: Not found connect port name "'+t+'"')},t}()),w=new(function(){function t(){return t.instance||(this.alarm=chrome.alarms||null,this.eventMap={},t.instance=this),t.instance}return t.prototype.create=function(t,e){if(!this.alarm)throw d(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw d(a.ERROR,"Not found alarm name.");return this.alarm.create(t,e),this.eventMap[t]={},this},t.prototype.addListener=function(t,e){var n=this;if(!this.alarm)throw d(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw d(a.ERROR,"Not found alarm name.");var i=m(5);return this.eventMap[t]||(this.eventMap[t]={}),Object.keys(this.eventMap[t]).length<1&&this.alarm.onAlarm.addListener((function(e){if(e.name==t&&n.eventMap[t])for(var i=0,r=Object.entries(n.eventMap[t]);i<r.length;i++){var o=r[i],s=o[0];(0,o[1])(s,e)}})),this.eventMap[t][i]=e,this},t.prototype.removeListener=function(t,e){if(!this.alarm)throw d(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw d(a.ERROR,"Not found alarm name.");return this.eventMap[t]&&(Object.keys(this.eventMap[t]).length<2?this.removeListeners(t):this.eventMap[t][e]&&delete this.eventMap[t][e]),this},t.prototype.removeListeners=function(t){var e=this;if(!this.alarm)throw d(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw d(a.ERROR,"Not found alarm name.");return this.eventMap[t]&&delete this.eventMap[t],this.alarm.onAlarm.removeListener((function(n){if(n.name==t&&e.eventMap[t])for(var i=0,r=Object.entries(e.eventMap[t]);i<r.length;i++){var o=r[i],s=o[0];(0,o[1])(s,n)}})),this},t.prototype.clear=function(t){if(!this.alarm)throw d(a.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw d(a.ERROR,"Not found alarm name.");return this.removeListeners(t),this.alarm.clear(t),this},t.prototype.clearAll=function(){if(!this.alarm)throw d(a.ERROR,"Not found chrome.alarm.");var t=Object.keys(this.eventMap)||[];if(t.length>0)for(var e=0,n=t;e<n.length;e++){var i=n[e];this.clear(i)}return this.alarm.clearAll(),this},t}()),_=new(function(){function t(){return t.instance||(this.notify=chrome.notifications,this.notifyMap={},t.instance=this),t.instance}return t.prototype.setupNotifyOption=function(t){this.notifyMap[t]||(this.notifyMap[t]={options:{},clicked:null,closed:null,buttonClicked:null,showSettings:null,permissionChanged:null})},t.prototype.setOptions=function(t,e){if(void 0===e&&(e={}),!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");return this.setupNotifyOption(t),this.notifyMap[t].options=Object.assign({},{type:"basic"},e),this},t.prototype.onClicked=function(t,e){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].clicked&&this.removeClicked(t),this.notifyMap[t].clicked=function(n){n==t&&e(t)};var n=this.notifyMap[t].clicked;return null!=n&&this.notify.onClicked.addListener(n),this},t.prototype.removeClicked=function(t){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].clicked;return null!=e&&(this.notify.onClicked.removeListener(e),this.notifyMap[t].clicked=null),this},t.prototype.onClosed=function(t,e){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].closed&&this.removeClosed(t),this.notifyMap[t].closed=function(n,i){n==t&&e(n,i)};var n=this.notifyMap[t].closed;return null!=n&&this.notify.onClosed.addListener(n),this},t.prototype.removeClosed=function(t){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].closed;return null!=e&&(this.notify.onClosed.removeListener(e),this.notifyMap[t].closed=null),this},t.prototype.onButtonClicked=function(t,e){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].buttonClicked&&this.removeButtonClicked(t),this.notifyMap[t].buttonClicked=function(n,i){n==t&&e(n,i)};var n=this.notifyMap[t].buttonClicked;return null!=n&&this.notify.onButtonClicked.addListener(n),this},t.prototype.removeButtonClicked=function(t){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].buttonClicked;return null!=e&&(this.notify.onButtonClicked.removeListener(e),this.notifyMap[t].buttonClicked=null),this},t.prototype.onPermissionChanged=function(t,e){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].permissionChanged&&this.removePermissionChanged(t),this.notifyMap[t].permissionChanged=e;var n=this.notifyMap[t].permissionChanged;return null!=n&&this.notify.onPermissionLevelChanged.addListener(n),this},t.prototype.removePermissionChanged=function(t){if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].permissionChanged;return null!=e&&(this.notify.onPermissionLevelChanged.removeListener(e),this.notifyMap[t].permissionChanged=null),this},t.prototype.create=function(t,e){var n=this;if(void 0===e&&(e={}),!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");return new Promise((function(i){var r=Object.assign({},e);n.notifyMap[t]&&n.notifyMap[t].options&&(r=Object.assign(r,n.notifyMap[t].options)),n.notify.create(t,r,(function(t){i(t)}))}))},t.prototype.update=function(t,e){var n=this;if(void 0===e&&(e={}),!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");return new Promise((function(i){var r=Object.assign({},e);n.notifyMap[t]&&n.notifyMap[t].options&&(r=Object.assign(r,n.notifyMap[t].options)),n.notify.update(t,r,(function(t){i(t)}))}))},t.prototype.getAll=function(){var t=this;if(!this.notify)throw d(a.ERROR,"Not found chrome.notifications.");return new Promise((function(e){t.notify.getAll(e)}))},t}());function R(t){var e="",n=null;if(t&&t.url){var i=(t.url||"").split("/");e=i[2]||"",n=(i.slice(0,3)||[]).join("/")}return{id:t.id||null,index:t.index,status:t.status||null,title:t.title||null,host:e,origin:n,favIcon:t.favIconUrl||null,windowId:t.windowId}}var E={tab:null,info:null},O=new(function(t){function e(){var n=this;return e.instance||((n=t.call(this)||this).tabs=chrome.tabs||null,n.activeId=null,n.tabItems={},n.eventsFlagMap={},n.eventsMap={},n.init(),e.instance=n),e.instance}return r(e,t),e.prototype.init=function(){var t=this;this.tabs&&this.tabs.query({},(function(e){e.map((function(e){if(null!=e){e.active&&(t.activeId=e.id||null);var n=R(e);e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n})}}))})),this.onActivated((function(e,n){null!=e&&(e.active&&(t.activeId=e.id||null),e.id&&(null!=n&&(t.tabItems[e.id]=n),e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n})))}),"___MTC_init___"),this.onUpdated((function(e,n){null!=e&&("loading"!=e.status&&(e.active&&(t.activeId=e.id||null),e.id&&(t.tabItems[e.id]||{origin:null}).origin!=n.origin&&(null!=n&&(t.tabItems[e.id]=n),e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n}))))}),"___MTC_init___"),this.onRemoved((function(e){try{t.tabItems[e]&&(t.emit("remove",{info:t.tabItems[e]}),delete t.tabItems[e])}catch(t){}}),"___MTC_init___"),this.getActiveTab().then((function(e){var n=e.tab,i=e.info;null!=n&&(n.active&&(t.activeId=n.id||null),n.id&&(null!=i&&(t.tabItems[n.id]=i),n.active&&t.emit("active",{tab:n,info:i}),t.emit("change",{tab:n,info:i})))}))},e.prototype.getInfo=function(t){return R(t)},e.prototype.getTab=function(t){var e=this;return new Promise((function(n,i){if(!e.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),i(E);try{try{e.tabs.get(t,(function(t){var e=R(t);n({tab:t,info:e})}))}catch(t){i(t)}}catch(t){i(t)}}))},e.prototype.getTabIndex=function(t,e){var n=this;return void 0===t&&(t=0),void 0===e&&(e=null),new Promise((function(i,r){if(!n.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),r(E);try{n.getTabs(e).then((function(e){if(!n.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),r(E);try{if(null==e)return i(E);if(null==e[t])return i(E);var o=(e[t].tab||{id:null}).id||null;if(null==o)return i(E);n.tabs.get(o,(function(t){var e=R(t);i({tab:t,info:e})}))}catch(t){r(t)}})).catch((function(t){r(t)}))}catch(t){r(t)}}))},e.prototype.getActiveTab=function(t){return void 0===t&&(t=0),o(this,void 0,void 0,(function(){var e;return s(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.getTabIndex(t,{active:!0})];case 1:return[2,n.sent()];case 2:return e=n.sent(),console.warn("BrowserExt: "+e.message||e),[2,{tab:null,info:null}];case 3:return[2]}}))}))},e.prototype.getItems=function(){var t=this;return new Promise((function(e){setTimeout((function(){for(var n={},i=0,r=Object.entries(t.tabItems);i<r.length;i++){var o=r[i],s=o[0],a=o[1];n[s]={info:a}}return e(n)}),100)}))},e.prototype.getActiveItem=function(){var t=this;return new Promise((function(e){setTimeout((function(){if(!t.activeId)return e(null);if(!t.tabItems[t.activeId])return e(null);var n=t.tabItems[t.activeId]||{};return e({tab:null,info:n})}),100)}))},e.prototype.getTabs=function(t){var e=this;return void 0===t&&(t=null),new Promise((function(n,i){if(!e.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),i(null);null==t&&(t={active:!0});try{e.tabs.query(t,(function(t){var e=[];t.map((function(t){var n=R(t);e.push({tab:t,info:n})})),n(e)}))}catch(t){i(t)}}))},e.prototype.onActivated=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;var i="activated";return this.eventsFlagMap[i]||(this.eventsMap[i]={},this.tabs.onActivated.addListener((function(t){n.tabs&&n.tabs.get(t.tabId,(function(t){try{var e=R(t);(Object.values(n.eventsMap[i])||[]).map((function(n){n(t,e)}))}catch(t){}}))})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t,this},e.prototype.removeActivated=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;var e="activated";if(!this.eventsFlagMap[e])return this;if(!this.eventsMap[e][t])return this;if("*"==t)for(var n=0,i=Object.entries(this.eventsMap[e]);n<i.length;n++){var r=i[n],o=r[0];r[1],"___MTC_init___"!=o&&delete this.eventsMap[e][o]}else delete this.eventsMap[e][t];return this},e.prototype.onUpdated=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;return this.eventsFlagMap.updated||(this.eventsMap.updated={},this.tabs.onUpdated.addListener((function(t,e,i){if(n.tabs&&i)try{var r=R(i);(Object.values(n.eventsMap.updated)||[]).map((function(t){t(i,r)}))}catch(t){}})),this.eventsFlagMap.updated=!0),this.eventsMap.updated[e]=t,this},e.prototype.removeUpdated=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;if(!this.eventsFlagMap.updated)return this;if(!this.eventsMap.updated[t])return this;if("*"==t)for(var e=0,n=Object.entries(this.eventsMap.updated);e<n.length;e++){var i=n[e],r=i[0];i[1],"___MTC_init___"!=r&&delete this.eventsMap.updated[r]}else delete this.eventsMap.updated[t];return this},e.prototype.onRemoved=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;return this.eventsFlagMap.removed||(this.eventsMap.removed={},this.tabs.onRemoved.addListener((function(t){n.tabs&&(Object.values(n.eventsMap.removed)||[]).map((function(e){e(t)}))})),this.eventsFlagMap.removed=!0),this.eventsMap.removed[e]=t,this},e.prototype.removeRemoved=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;if(!this.eventsFlagMap.removed)return this;if(!this.eventsMap.removed[t])return this;if("*"==t)for(var e=0,n=Object.entries(this.eventsMap.removed);e<n.length;e++){var i=n[e],r=i[0];i[1],"___MTC_init___"!=r&&delete this.eventsMap.removed[r]}else delete this.eventsMap.removed[t];return this},e}(e.EventEmitter));O.setMaxListeners(100);var C={runtime:n,message:M,port:b,alarms:w,notify:_,tabs:O,storage:v};module.exports=C;
