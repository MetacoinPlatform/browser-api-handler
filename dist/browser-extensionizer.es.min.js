import{createHash as t,createHmac as e,randomBytes as n,createCipheriv as i,createDecipheriv as o}from"crypto";import{EventEmitter as r}from"events";var s=new(function(){function t(){this.eventsFlagMap={},this.eventsMap={},this.runtime=chrome.runtime||null,this.commands=chrome.commands||null}return t.prototype.eventFunction=function(t,e){var n=this.eventsMap[t]||{};if(Object.keys(n).length>0)for(var i=0,o=Object.entries(n);i<o.length;i++){var r=o[i],s=r[0];(0,r[1])({key:s,data:e})}},t.prototype.removeEventFunction=function(t,e){if(this.eventsFlagMap[t]&&this.eventsMap[t][e])return"*"==e?(delete this.eventsMap[t],this.eventsMap[t]={}):delete this.eventsMap[t][e],Object.keys(this.eventsMap[t]).length<1},t.prototype.onInstalled=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.runtime)return console.warn("BrowserExt: Not support chrome.runtime");var i="installed";this.eventsFlagMap[i]||(this.eventsMap[i]={},this.runtime.onInstalled.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t},t.prototype.removeInstalled=function(t){var e=this;if(this.runtime){var n="installed";this.removeEventFunction(n,t)||(this.runtime.onInstalled.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap[n]=!1)}},t.prototype.onConnect=function(t,e){var n=this;if(void 0===e&&(e="init"),this.runtime){var i="connect";this.eventsFlagMap.connect||(this.eventsMap.connect={},this.runtime.onConnect.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap.connect=!0),this.eventsMap.connect[e]=t}},t.prototype.removeConnect=function(t){var e=this;if(this.runtime){var n="connect";this.removeEventFunction(n,t)||(this.runtime.onConnect.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap.connect=!1)}},t.prototype.onConnectExternal=function(t,e){var n=this;if(void 0===e&&(e="init"),this.runtime){var i="connectExternal";this.eventsFlagMap[i]||(this.eventsMap[i]={},this.runtime.onConnectExternal.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t}},t.prototype.removeConnectExternal=function(t){var e=this;if(this.runtime){var n="connectExternal";this.removeEventFunction(n,t)||(this.runtime.onConnectExternal.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap[n]=!1)}},t.prototype.onCommand=function(t,e){var n=this;if(void 0===e&&(e="init"),this.commands){var i="command";this.eventsFlagMap.command||(this.eventsMap.command={},this.commands.onCommand.addListener((function(t){return n.eventFunction(i,t)})),this.eventsFlagMap.command=!0),this.eventsMap.command[e]=t}},t.prototype.removeCommand=function(t){var e=this;if(this.runtime){var n="command";this.removeEventFunction(n,t)||(this.runtime.onConnectExternal.removeListener((function(t){return e.eventFunction(n,t)})),this.eventsFlagMap.command=!1)}},t}()),a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function u(t,e){function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function c(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{u(i.next(t))}catch(t){r(t)}}function a(t){try{u(i.throw(t))}catch(t){r(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))}function h(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}var l,f,d,p=function(e,n){return t(e).update(String(n)).digest("hex")},v=function(t,n,i,o){void 0===i&&(i="sha256"),void 0===o&&(o=!0);var r=e(i,n);return r.update(t),o?r.digest("hex"):r.digest()},m=function(t,e){t=String(t);var o=p("md5",e),r=n(16),s=i("aes-256-cbc",Buffer.from(o),r),a=s.update(t);a=Buffer.concat([a,s.final()]);var u=v(a,o,"sha256",!1);return Buffer.concat([r,u,a]).toString("base64")},y=function(t,e){t=String(t);var n=p("md5",e),i=Buffer.from(t,"base64"),r=Buffer.from(i.slice(0,16));i=i.slice(48);var s=o("aes-256-cbc",Buffer.from(n),r),a=s.update(i);return(a=Buffer.concat([a,s.final()])).toString()},w={Hash:p,HashHmac:v,encryptData:m,decryptData:y},g=Object.freeze({__proto__:null,Hash:p,HashHmac:v,encryptData:m,decryptData:y,default:w});!function(t){t.SUCCESS="SUCCESS",t.ERROR="ERROR",t.WARNING="WARNING",t.DENIED="DENIED"}(l||(l={})),function(t){t.LOCALSTORAGE="localStorage",t.LOCAL="local",t.SYNC="sync"}(f||(f={})),function(t){t.LOCAL="LOCAL",t.BRWOSER="BRWOSER"}(d||(d={}));var _=!1,b=new(function(t){function e(){var e=t.call(this)||this;e.setMaxListeners(100),e.storageType=d.BRWOSER,e.supportStorage=!0;try{e.changeType(f.LOCAL)}catch(t){e.changeType(f.LOCALSTORAGE)}return e}return u(e,t),e.prototype.changeType=function(t){var e=this;if(!this.supportStorage)return this.storageType=d.LOCAL,this.storage=localStorage,this;try{t==f.LOCALSTORAGE?(this.storageType=d.LOCAL,this.storage=localStorage):t==f.SYNC?(this.storageType=d.BRWOSER,this.storage=chrome.storage.sync):t==f.LOCAL&&(this.storageType=d.BRWOSER,this.storage=chrome.storage.local),this.storageType==d.BRWOSER&&(_||(_=!0,chrome.storage.onChanged.addListener((function(t){e.emit("change",t)}))))}catch(t){}return this.emit("changeType",this.storageType),this},e.prototype.save=function(t,e){var n=this;return new Promise((function(i){var o;if(n.storageType==d.LOCAL)n.storage.setItem(t,e),n.emit("save",{key:t,val:e}),i();else{var r=""+t;n.storage.set(((o={})[r]=e,o),(function(){n.emit("save",{key:r,val:e}),i()}))}}))},e.prototype.load=function(t){var e=this;return new Promise((function(n){if(e.storageType==d.LOCAL){var i=e.storage.getItem(t)||null;n(i),e.emit("load",{key:t,val:i})}else{var o=""+t;e.storage.get([o],(function(t){try{e.emit("load",{key:o,val:t[o]}),n(t[o])}catch(t){n(void 0)}}))}}))},e.prototype.remove=function(t){var e=this;return new Promise((function(n){if(e.storageType==d.LOCAL)e.emit("remove",{key:t}),n(e.storage.removeItem(t)||null);else{var i=""+t;e.storage.remove([i],(function(t){try{e.emit("remove",{key:i}),n(t[i])}catch(t){n(void 0)}}))}}))},e.prototype.loadRemove=function(t){var e=this;return new Promise((function(n){return c(e,void 0,void 0,(function(){var e;return h(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.load(t)];case 1:return e=i.sent(),[4,this.remove(t)];case 2:return i.sent(),n(e),[3,4];case 3:throw i.sent();case 4:return[2]}}))}))}))},e}(r)),R=function(t,e,n){return void 0===e&&(e=""),void 0===n&&(n=null),{result:t,msg:e,data:n}},M=function(t,e){var n;void 0===e&&(e=!0);for(var i="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_"+(e?"":"0123456789"),r=o.length,s=0;s<t;s++)i+=o.charAt(Math.floor(Math.random()*r));if(e){for(var a=(i+=String(Date.now())).split(""),u=a.length-1;u>0;u--){var c=Math.floor(Math.random()*(u+1));n=[a[c],a[u]],a[u]=n[0],a[c]=n[1]}i=a.join("")}return i},E=function(t,e){return c(void 0,void 0,void 0,(function(){var n,i,o,r,s,a,u,c,l;return h(this,(function(h){switch(h.label){case 0:n=p("sha256",Math.random()+Date.now()),h.label=1;case 1:return h.trys.push([1,3,,4]),[4,b.save("blockdata:"+t,n)];case 2:return h.sent(),[3,4];case 3:throw h.sent();case 4:for((i={}).isEncrypt=!0,o=0,r=Object.entries(e);o<r.length;o++)s=r[o],a=s[0],u=s[1],c=!0,l=u,"object"==typeof u||Array.isArray(u)?u=JSON.stringify(u):"boolean"==typeof u&&(c=!1,l=u),c&&(l=m(u,n)),i[a]=l;return[2,i]}}))}))},O=function(t,e){return c(void 0,void 0,void 0,(function(){var n,i,o,r,s,a,u,c;return h(this,(function(h){switch(h.label){case 0:n=null,h.label=1;case 1:return h.trys.push([1,3,,4]),[4,b.loadRemove("blockdata:"+t)];case 2:return n=h.sent(),[3,4];case 3:throw h.sent();case 4:if(!n)throw new Error("BrowserExt: Not found port crypt");for(i={},o=0,r=Object.entries(e);o<r.length;o++){s=r[o],a=s[0],("object"==typeof(u=s[1])||Array.isArray(u))&&(u=JSON.stringify(u));try{c=y(u,n);try{i[a]=JSON.parse(c)}catch(t){i[a]=c}}catch(t){i[a]=u}}return[2,i||null]}}))}))},L=new(function(){function t(){this.runtime=chrome.runtime||null,this.tabs=chrome.tabs||null}return t.prototype.send=function(t,e,n){var i=this;return void 0===e&&(e={}),void 0===n&&(n=!1),new Promise((function(o,r){return c(i,void 0,void 0,(function(){var i,s,a;return h(this,(function(u){switch(u.label){case 0:if(!this.runtime)return[2,r()];u.label=1;case 1:return u.trys.push([1,4,,5]),i="s:"+t+M(6),s=e,n?[4,E(i,e)]:[3,3];case 2:s=u.sent(),u.label=3;case 3:return this.runtime.sendMessage({__id__:i,method:t,param:s},(function(t){if(t&&t.result&&"SUCCESS"!=t.result)return r(t);o(t)})),[3,5];case 4:return a=u.sent(),r(a),[3,5];case 5:return[2]}}))}))}))},t.prototype.sendTab=function(t,e,n,i){return void 0===n&&(n={}),void 0===i&&(i=!1),c(this,void 0,void 0,(function(){var o=this;return h(this,(function(r){return[2,new Promise((function(r,s){return c(o,void 0,void 0,(function(){var o,a,u;return h(this,(function(c){switch(c.label){case 0:if(!this.tabs)return[2,s()];c.label=1;case 1:return c.trys.push([1,4,,5]),o="s:"+e+M(6),a=n,i&&n?[4,E(o,n)]:[3,3];case 2:a=c.sent(),c.label=3;case 3:return this.tabs.sendMessage(t,{__id__:o,method:e,param:a},(function(t){if(t&&"SUCCESS"!=t.result)return s(t);r(t)})),[3,5];case 4:return u=c.sent(),s(u),[3,5];case 5:return[2]}}))}))}))]}))}))},t.prototype.on=function(t,e){var n=this;if(void 0===e&&(e=""),!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;e.length<1&&(e=this.runtime.id);var i=function(i,o,r){var s=i.__id__||null,a=i.method||null,u=i.param||{};if(e&&o.id!=e)return!0;try{var l=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),r({result:t,msg:e,data:n})},f=u;if(u&&"object"==typeof u&&!0===u.isEncrypt){c(n,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,O(s||0,u)];case 1:return f=e.sent(),[3,3];case 2:return e.sent(),[2,!1];case 3:return t({method:a,sender:o,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else t({method:a,sender:o,oriParam:i,param:f,sendResult:l})}catch(t){}return!0};return this.runtime.onMessage.addListener(i),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onMessage.removeListener(i)}}},t.prototype.onExternal=function(t,e){var n=this;if(void 0===e&&(e=""),!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;e.length<1&&(e=this.runtime.id);var i=function(i,o,r){var s=i.__id__||null,a=i.method||null,u=i.param;if(e&&o.id!=e)return!0;try{var l=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),r({result:t,msg:e,data:n})},f=u;if(u&&"object"==typeof u&&!0===u.isEncrypt){c(n,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,O(s||0,u)];case 1:return f=e.sent(),[3,3];case 2:throw e.sent();case 3:return t({method:a,sender:o,oriParam:i,param:f,sendResult:l}),[2]}}))}))}else t({method:a,sender:o,oriParam:i,param:f,sendResult:l})}catch(t){}return!0};return this.runtime.onMessageExternal.addListener(i),{removeListener:function(){var t;null===(t=n.runtime)||void 0===t||t.onMessageExternal.removeListener(i)}}},t}()),C=new(function(){function t(){this.__id__=0,this.__timeout__=24e4,this.portMap={},this.runtime=chrome.runtime||null}return t.prototype.setTimeout=function(t){return void 0===t&&(t=24e4),this.__timeout__=t,this},t.prototype.connect=function(t){var e=this;if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;if(this.portMap[t])return this.portMap[t];var n=this.runtime.connect({name:t});this.portMap[t]=n;var i=function(){var n=e.portMap[t];delete e.portMap[t],n.onDisconnect.removeListener(i)};return n.onDisconnect.addListener(i),n},t.prototype.disConnect=function(t){if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),!1;if(this.portMap[t]){var e=this.portMap[t]||null;e&&e.disconnect()}return!0},t.prototype.onDisconnect=function(t,e){if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),this;if(!this.portMap[t])return this;var n=this.portMap[t];return n?(n.onDisconnect.addListener(e),this):this},t.prototype.send=function(t,e,n,i,o){return void 0===n&&(n={}),void 0===i&&(i=!1),void 0===o&&(o=null),c(this,void 0,void 0,(function(){var r,s,a,u,c;return h(this,(function(h){switch(h.label){case 0:if(!(r=this.connect(t)))return console.warn('BrowserExt: Not found connect port name "'+t+'"'),[2];h.label=1;case 1:return h.trys.push([1,4,,5]),this.__id__++,this.__id__>1e9&&(this.__id__=1),s=this.__id__,a=n,i?[4,E(s,n)]:[3,3];case 2:a=h.sent(),h.label=3;case 3:return null!=o&&(u=!1,c=function(n){r&&n.name&&n.name==t&&n.__id__&&n.__id__==s&&n.method==e&&(r.onMessage.removeListener(c),null!=o&&(u=!0,o(n)))},r.onMessage.addListener(c),setTimeout((function(){r&&(u||o({__id__:s,name:t,method:e,result:l.ERROR,msg:"Return failure due to timeout",data:null}),r.onMessage.removeListener(c))}),this.__timeout__)),r.postMessage({__id__:s,name:t,method:e,param:a}),[3,5];case 4:throw h.sent();case 5:return[2]}}))}))},t.prototype.on=function(t,e){var n=this;if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;t.length<1&&(t="*");var i=function(i,o){var r=i.__id__||null,s=i.method||null,a=i.param,u=function(e,n,i){if(void 0===e&&(e=l.SUCCESS),void 0===n&&(n=null),void 0===i&&(i=null),o&&o.postMessage){var a={name:t,method:s,result:e,msg:n,data:i};null!=r&&(a.__id__=r),o.postMessage(a)}},f=a;if(a&&"object"==typeof a&&!0===a.isEncrypt){c(n,void 0,void 0,(function(){return h(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,O(r||0,a)];case 1:return f=t.sent(),[3,3];case 2:throw t.sent();case 3:return e({port:o,method:s,oriParam:i,param:f,sendResult:u}),[2]}}))}))}else e({port:o,method:s,oriParam:i,param:f,sendResult:u});return!0};this.onConnect(t,(function(t){t.port.onMessage.addListener(i)}),(function(e){e.port.onMessage.removeListener(i),n.portMap[t]=null}))},t.prototype.onConnect=function(t,e,n){var i=this;if(!this.runtime)return console.warn("BrowserExt: Not found browser API."),null;t.length<1&&(t="*");var o=function(i){if("*"!=t&&i.name!=t)return!0;i.onDisconnect.addListener((function(){n({name:t,port:i})})),e({name:t,port:i})};return this.runtime.onConnect.addListener(o),{removeListener:function(){var t;null===(t=i.runtime)||void 0===t||t.onConnect.removeListener(o)}}},t}()),N=new(function(){function t(){this.notify=chrome.notifications,this.notifyMap={}}return t.prototype.setupNotifyOption=function(t){this.notifyMap[t]||(this.notifyMap[t]={options:{},clicked:null,closed:null,buttonClicked:null,showSettings:null,permissionChanged:null})},t.prototype.setOptions=function(t,e){if(void 0===e&&(e={}),!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");return this.setupNotifyOption(t),this.notifyMap[t].options=Object.assign({},{type:"basic"},e),this},t.prototype.onClicked=function(t,e){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].clicked&&this.removeClicked(t),this.notifyMap[t].clicked=function(n){n==t&&e(t)};var n=this.notifyMap[t].clicked;return null!=n&&this.notify.onClicked.addListener(n),this},t.prototype.removeClicked=function(t){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].clicked;return null!=e&&(this.notify.onClicked.removeListener(e),this.notifyMap[t].clicked=null),this},t.prototype.onClosed=function(t,e){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].closed&&this.removeClosed(t),this.notifyMap[t].closed=function(n,i){n==t&&e(n,i)};var n=this.notifyMap[t].closed;return null!=n&&this.notify.onClosed.addListener(n),this},t.prototype.removeClosed=function(t){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].closed;return null!=e&&(this.notify.onClosed.removeListener(e),this.notifyMap[t].closed=null),this},t.prototype.onButtonClicked=function(t,e){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].buttonClicked&&this.removeButtonClicked(t),this.notifyMap[t].buttonClicked=function(n,i){n==t&&e(n,i)};var n=this.notifyMap[t].buttonClicked;return null!=n&&this.notify.onButtonClicked.addListener(n),this},t.prototype.removeButtonClicked=function(t){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].buttonClicked;return null!=e&&(this.notify.onButtonClicked.removeListener(e),this.notifyMap[t].buttonClicked=null),this},t.prototype.onPermissionChanged=function(t,e){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");this.setupNotifyOption(t),this.notifyMap[t].permissionChanged&&this.removePermissionChanged(t),this.notifyMap[t].permissionChanged=e;var n=this.notifyMap[t].permissionChanged;return null!=n&&this.notify.onPermissionLevelChanged.addListener(n),this},t.prototype.removePermissionChanged=function(t){if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");if(!this.notifyMap[t])return this;var e=this.notifyMap[t].permissionChanged;return null!=e&&(this.notify.onPermissionLevelChanged.removeListener(e),this.notifyMap[t].permissionChanged=null),this},t.prototype.create=function(t,e){var n=this;if(void 0===e&&(e={}),!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");return new Promise((function(i){var o=Object.assign({},e);n.notifyMap[t]&&n.notifyMap[t].options&&(o=Object.assign(o,n.notifyMap[t].options)),n.notify.create(t,o,(function(t){i(t)}))}))},t.prototype.update=function(t,e){var n=this;if(void 0===e&&(e={}),!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");return new Promise((function(i){var o=Object.assign({},e);n.notifyMap[t]&&n.notifyMap[t].options&&(o=Object.assign(o,n.notifyMap[t].options)),n.notify.update(t,o,(function(t){i(t)}))}))},t.prototype.getAll=function(){var t=this;if(!this.notify)throw R(l.ERROR,"Not found chrome.notifications.");return new Promise((function(e){t.notify.getAll(e)}))},t}()),A=new(function(){function t(){this.alarm=chrome.alarms||null,this.eventMap={}}return t.prototype.create=function(t,e){if(!this.alarm)throw R(l.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw R(l.ERROR,"Not found alarm name.");return this.alarm.create(t,e),this},t.prototype.addListener=function(t,e){var n=this;if(!this.alarm)throw R(l.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw R(l.ERROR,"Not found alarm name.");return Object.keys(this.eventMap).length<1&&this.alarm.onAlarm.addListener((function(t){var e=t.name||"";n.eventMap[e]&&n.eventMap[e](t)})),this.eventMap[t]||(this.eventMap[t]=e),this},t.prototype.removeListener=function(t){if(!this.alarm)throw R(l.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw R(l.ERROR,"Not found alarm name.");return this.eventMap[t]&&delete this.eventMap[t],this},t.prototype.removeListeners=function(t){var e=this;if(!this.alarm)throw R(l.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw R(l.ERROR,"Not found alarm name.");return this.alarm.onAlarm.removeListener((function(t){var n=t.name||"";e.eventMap[n]&&e.eventMap[n](t)})),this.eventMap={},this},t.prototype.clear=function(t){if(!this.alarm)throw R(l.ERROR,"Not found chrome.alarm.");if(!t||!t.trim())throw R(l.ERROR,"Not found alarm name.");return this.removeListeners(t),this.alarm.clear(t),this},t.prototype.clearAll=function(){if(!this.alarm)throw R(l.ERROR,"Not found chrome.alarm.");var t=Object.keys(this.eventMap)||[];if(t.length>0)for(var e=0,n=t;e<n.length;e++){var i=n[e];this.clear(i)}return this.alarm.clearAll(),this},t}());function S(t){var e="",n=null;if(t&&t.url){var i=(t.url||"").split("/");e=i[2]||"",n=(i.slice(0,3)||[]).join("/")}return{id:t.id||null,index:t.index,status:t.status||null,title:t.title||null,host:e,origin:n,favIcon:t.favIconUrl||null,windowId:t.windowId}}var T,k={tab:null,info:null},x=function(t){function e(){var e=t.call(this)||this;return e.setMaxListeners(100),e.tabs=chrome.tabs||null,e.activeId=null,e.tabItems={},e.eventsFlagMap={},e.eventsMap={},e.init(),e}return u(e,t),e.prototype.init=function(){var t=this;this.tabs&&this.tabs.query({},(function(e){e.map((function(e){if(null!=e){e.active&&(t.activeId=e.id||null);var n=S(e);e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n})}}))})),this.onActivated((function(e,n){null!=e&&(e.active&&(t.activeId=e.id||null),e.id&&(null!=n&&(t.tabItems[e.id]=n),e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n})))}),"___MTC_init___"),this.onUpdated((function(e,n){null!=e&&("loading"!=e.status&&(e.active&&(t.activeId=e.id||null),e.id&&(t.tabItems[e.id]||{origin:null}).origin!=n.origin&&(null!=n&&(t.tabItems[e.id]=n),e.active&&t.emit("active",{tab:e,info:n}),t.emit("change",{tab:e,info:n}))))}),"___MTC_init___"),this.onRemoved((function(e){try{t.tabItems[e]&&(t.emit("remove",{info:t.tabItems[e]}),delete t.tabItems[e])}catch(t){}}),"___MTC_init___"),this.getActiveTab().then((function(e){var n=e.tab,i=e.info;null!=n&&(n.active&&(t.activeId=n.id||null),n.id&&(null!=i&&(t.tabItems[n.id]=i),n.active&&t.emit("active",{tab:n,info:i}),t.emit("change",{tab:n,info:i})))}))},e.prototype.getInfo=function(t){return S(t)},e.prototype.getTab=function(t){var e=this;return new Promise((function(n,i){if(!e.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),i(k);try{try{e.tabs.get(t,(function(t){var e=S(t);n({tab:t,info:e})}))}catch(t){i(t)}}catch(t){i(t)}}))},e.prototype.getTabIndex=function(t,e){var n=this;return void 0===t&&(t=0),void 0===e&&(e=null),new Promise((function(i,o){if(!n.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),o(k);try{n.getTabs(e).then((function(e){if(!n.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),o(k);try{if(null==e)return i(k);if(null==e[t])return i(k);var r=(e[t].tab||{id:null}).id||null;if(null==r)return i(k);n.tabs.get(r,(function(t){var e=S(t);i({tab:t,info:e})}))}catch(t){o(t)}})).catch((function(t){o(t)}))}catch(t){o(t)}}))},e.prototype.getActiveTab=function(t){return void 0===t&&(t=0),c(this,void 0,void 0,(function(){var e;return h(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.getTabIndex(t,{active:!0})];case 1:return[2,n.sent()];case 2:return e=n.sent(),console.warn("BrowserExt: "+e.message||e),[2,{tab:null,info:null}];case 3:return[2]}}))}))},e.prototype.getItems=function(){var t=this;return new Promise((function(e){setTimeout((function(){for(var n={},i=0,o=Object.entries(t.tabItems);i<o.length;i++){var r=o[i],s=r[0],a=r[1];n[s]={info:a}}return e(n)}),100)}))},e.prototype.getActiveItem=function(){var t=this;return new Promise((function(e){setTimeout((function(){if(!t.activeId)return e(null);if(!t.tabItems[t.activeId])return e(null);var n=t.tabItems[t.activeId]||{};return e({tab:null,info:n})}),100)}))},e.prototype.getTabs=function(t){var e=this;return void 0===t&&(t=null),new Promise((function(n,i){if(!e.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),i(null);null==t&&(t={active:!0});try{e.tabs.query(t,(function(t){var e=[];t.map((function(t){var n=S(t);e.push({tab:t,info:n})})),n(e)}))}catch(t){i(t)}}))},e.prototype.onActivated=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;var i="activated";return this.eventsFlagMap[i]||(this.eventsMap[i]={},this.tabs.onActivated.addListener((function(t){n.tabs&&n.tabs.get(t.tabId,(function(t){try{var e=S(t);(Object.values(n.eventsMap[i])||[]).map((function(n){n(t,e)}))}catch(t){}}))})),this.eventsFlagMap[i]=!0),this.eventsMap[i][e]=t,this},e.prototype.removeActivated=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;var e="activated";if(!this.eventsFlagMap[e])return this;if(!this.eventsMap[e][t])return this;if("*"==t)for(var n=0,i=Object.entries(this.eventsMap[e]);n<i.length;n++){var o=i[n],r=o[0];o[1],"___MTC_init___"!=r&&delete this.eventsMap[e][r]}else delete this.eventsMap[e][t];return this},e.prototype.onUpdated=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;return this.eventsFlagMap.updated||(this.eventsMap.updated={},this.tabs.onUpdated.addListener((function(t,e,i){if(n.tabs&&i)try{var o=S(i);(Object.values(n.eventsMap.updated)||[]).map((function(t){t(i,o)}))}catch(t){}})),this.eventsFlagMap.updated=!0),this.eventsMap.updated[e]=t,this},e.prototype.removeUpdated=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;if(!this.eventsFlagMap.updated)return this;if(!this.eventsMap.updated[t])return this;if("*"==t)for(var e=0,n=Object.entries(this.eventsMap.updated);e<n.length;e++){var i=n[e],o=i[0];i[1],"___MTC_init___"!=o&&delete this.eventsMap.updated[o]}else delete this.eventsMap.updated[t];return this},e.prototype.onRemoved=function(t,e){var n=this;if(void 0===e&&(e="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;return this.eventsFlagMap.removed||(this.eventsMap.removed={},this.tabs.onRemoved.addListener((function(t){n.tabs&&(Object.values(n.eventsMap.removed)||[]).map((function(e){e(t)}))})),this.eventsFlagMap.removed=!0),this.eventsMap.removed[e]=t,this},e.prototype.removeRemoved=function(t){if(void 0===t&&(t="init"),!this.tabs)return console.warn("BrowserExt: Not support chrome.tabs"),this;if(!this.eventsFlagMap.removed)return this;if(!this.eventsMap.removed[t])return this;if("*"==t)for(var e=0,n=Object.entries(this.eventsMap.removed);e<n.length;e++){var i=n[e],o=i[0];i[1],"___MTC_init___"!=o&&delete this.eventsMap.removed[o]}else delete this.eventsMap.removed[t];return this},e}(r),I=!1,B=new(function(t){function e(){var e=t.call(this)||this;e.setMaxListeners(100),e.storageType=d.BRWOSER,e.supportStorage=!0;try{e.changeType(f.LOCAL)}catch(t){e.changeType(f.LOCALSTORAGE)}return e}return u(e,t),e.prototype.changeType=function(t){var e=this;if(!this.supportStorage)return this.storageType=d.LOCAL,this.storage=localStorage,this;try{t==f.LOCALSTORAGE?(this.storageType=d.LOCAL,this.storage=localStorage):t==f.SYNC?(this.storageType=d.BRWOSER,this.storage=chrome.storage.sync):t==f.LOCAL&&(this.storageType=d.BRWOSER,this.storage=chrome.storage.local),this.storageType==d.BRWOSER&&(I||(I=!0,chrome.storage.onChanged.addListener((function(t){e.emit("change",t)}))))}catch(t){}return this.emit("changeType",this.storageType),this},e.prototype.save=function(t,e){var n=this;return new Promise((function(i){var o;if(n.storageType==d.LOCAL)n.storage.setItem(t,e),n.emit("save",{key:t,val:e}),i();else{var r=""+t;n.storage.set(((o={})[r]=e,o),(function(){n.emit("save",{key:r,val:e}),i()}))}}))},e.prototype.load=function(t){var e=this;return new Promise((function(n){if(e.storageType==d.LOCAL){var i=e.storage.getItem(t)||null;n(i),e.emit("load",{key:t,val:i})}else{var o=""+t;e.storage.get([o],(function(t){try{e.emit("load",{key:o,val:t[o]}),n(t[o])}catch(t){n(void 0)}}))}}))},e.prototype.remove=function(t){var e=this;return new Promise((function(n){if(e.storageType==d.LOCAL)e.emit("remove",{key:t}),n(e.storage.removeItem(t)||null);else{var i=""+t;e.storage.remove([i],(function(t){try{e.emit("remove",{key:i}),n(t[i])}catch(t){n(void 0)}}))}}))},e.prototype.loadRemove=function(t){var e=this;return new Promise((function(n){return c(e,void 0,void 0,(function(){var e;return h(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.load(t)];case 1:return e=i.sent(),[4,this.remove(t)];case 2:return i.sent(),n(e),[3,4];case 3:throw i.sent();case 4:return[2]}}))}))}))},e}(r)),P={},F={},j=new(function(t){function e(){var e=t.call(this)||this;return e.setMaxListeners(100),e.window=chrome.windows||null,e.isAddEvent=!1,e}return u(e,t),e.prototype.get=function(t){if(!this.window)throw R(l.ERROR,"Not found chrome.windows.");return F[t]||null},e.prototype.getId=function(t,e){if(!this.window)throw R(l.ERROR,"Not found chrome.windows.");this.window.get(t,(function(t){e(t)}))},e.prototype.getAll=function(t){if(!this.window)throw R(l.ERROR,"Not found chrome.windows.");this.window.getAll(t)},e.prototype.open=function(t,e,n){var i=this;if(void 0===n&&(n=!1),!this.window)throw R(l.ERROR,"Not found chrome.windows.");if(Object.keys(e).length<1)throw R(l.ERROR,"Required create option");this.isAddEvent||(this.isAddEvent=!0,this.window.onRemoved.addListener((function(t){if(void 0!==t&&void 0!==P[t]){var e=P[t];void 0!==F[e._name]&&delete F[e._name],delete P[t],i.emit("remove",e)}}))),n&&void 0!==F[t]?(this.window.update(F[t].id,{focused:!0}),this.emit("update",P[F[t].id])):this.window.create(e,(function(e){void 0!==e&&(F[t]=e,P[e.id]=Object.assign({_name:t},e),i.emit("create",P[e.id]))}))},e.prototype.update=function(t,e,n){if(!this.window)throw R(l.ERROR,"Not found chrome.windows.");this.window.update(t,e,n)},e.prototype.close=function(t){var e=this;if(!this.window)throw R(l.ERROR,"Not found chrome.windows.");if(!t)throw R(l.ERROR,"Required window id");this.window.remove(t,(function(t){if(void 0!==t&&void 0!==P[t]){var n=P[t];void 0!==F[n._name]&&delete F[n._name],delete P[t],e.emit("remove",n)}}))},e}(r));!function(t){t.LOAD="load",t.MESSAGE="message",t.REMOVE="remove"}(T||(T={}));var D=function(t){function e(e,n){var i=t.call(this)||this;return i.__id__=0,i.__timeout__=36e4,i.isRun=!1,i.replay=0,i.name=e,i.recvName=n||e,i}return u(e,t),e.prototype.shouldWindow=function(){return this.doctypeCheck()&&this.suffixCheck()&&this.documentElementCheck()},e.prototype.doctypeCheck=function(){var t=window.document.doctype;return!t||"html"===t.name},e.prototype.suffixCheck=function(){for(var t=[/\.xml$/u,/\.pdf$/u],e=window.location.pathname,n=0;n<t.length;n++)if(t[n].test(e))return!1;return!0},e.prototype.documentElementCheck=function(){var t=document.documentElement.nodeName;return!t||"html"===t.toLowerCase()},e.prototype.setupEvent=function(){return c(this,void 0,void 0,(function(){var t,e,n=this;return h(this,(function(i){return this.isRun?[2]:this.shouldWindow?(this.isRun=!0,t=function(t){n.emit("load",{name:n.name,data:null,event:t})},e=function(t){var e=t.data||{};if(e.name==n.name){var i=e.__id__||null,o=e.method||null;n.emit("message",{name:n.name,method:o,data:e.data,event:t,sendResult:function(e,o){window.postMessage({__id__:i,name:n.recvName,method:e,data:o||null},t.origin||window.origin||"*")}})}},window.addEventListener("load",t),window.addEventListener("message",e),window.addEventListener("unload",(function(i){window.removeEventListener("load",t),window.removeEventListener("message",e),n.emit("remove",{name:n.name,data:null,event:i})})),[2]):(this.replay++,setTimeout((function(){n.replay>10?console.warn("Metawallet: Not found window."):n.setupEvent()}),1e3),[2])}))}))},e.prototype.setTimeout=function(t){return void 0===t&&(t=36e4),this.__timeout__=t,this},e.prototype.send=function(t,e,n){var i=this;if(void 0===e&&(e={}),!this.isRun||!this.shouldWindow)throw new Error("DappSDK: Wait for connect.");this.__id__++,this.__id__>1e9&&(this.__id__=1);var o=this.__id__,r=window.origin||"*";try{if(null!=n){var s=!1,a=function(u){if(u.origin==r){var c=u.data||{};c.name==i.recvName&&c.__id__&&c.__id__==o&&c.method==t&&(window.removeEventListener("message",a),null!=n&&(s=!0,n({__id__:o,name:i.name,method:t,status:l.SUCCESS,msg:null,data:e||null})))}};window.addEventListener("message",a),setTimeout((function(){s||window.removeEventListener("message",a),n({__id__:o,name:i.name,method:t,status:l.ERROR,msg:"Connection timed out.",data:null})}),this.__timeout__)}window.postMessage({__id__:o,name:this.recvName,method:t,data:e},r)}catch(t){throw t}},e}(r),W={runtime:s,message:L,port:C,alarms:A,notify:N,tabs:function(){return new x},storage:B,window:j,windowMessage:function(t,e){var n=new D(t,e);return n.setMaxListeners(100),n.setupEvent(),n},crypt:g};export default W;
